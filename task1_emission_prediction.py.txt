import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.linear_model import Ridge
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score

# Load EDGAR dataset
url = "https://raw.githubusercontent.com/openclimatedata/edgar-co2-emissions/master/EDGARv6_CO2_total_emissions.csv"
df = pd.read_csv(url).dropna()

# Filter proxy data for BASF (Germany Industrial Sector)
basf_df = df[(df['Country'] == 'Germany') & (df['Sector'] == 'Industry')].copy()

# Feature Engineering
basf_df['CO2_lag1'] = basf_df['CO2_emissions'].shift(1)
basf_df['CO2_lag2'] = basf_df['CO2_emissions'].shift(2)
basf_df['CO2_roll3'] = basf_df['CO2_emissions'].rolling(3).mean()
basf_df.dropna(inplace=True)

X = basf_df[['Year', 'CO2_lag1', 'CO2_lag2', 'CO2_roll3']]
y = basf_df['CO2_emissions']

split_year = 2018
X_train, X_test = X[X['Year'] <= split_year], X[X['Year'] > split_year]
y_train, y_test = y[X['Year'] <= split_year], y[X['Year'] > split_year]

# Models
ridge = Ridge(alpha=1.0).fit(X_train, y_train)
rf = RandomForestRegressor(n_estimators=200, random_state=42).fit(X_train, y_train)

y_pred_ridge = ridge.predict(X_test)
y_pred_rf = rf.predict(X_test)

def evaluate(y_true, y_pred):
    return np.sqrt(mean_squared_error(y_true, y_pred)), mean_absolute_error(y_true, y_pred), r2_score(y_true, y_pred)

print("Ridge:", evaluate(y_test, y_pred_ridge))
print("Random Forest:", evaluate(y_test, y_pred_rf))

# Plot
plt.plot(y_test.values, label="Actual")
plt.plot(y_pred_rf, label="Predicted RF")
plt.legend()
plt.title("Actual vs Predicted COâ‚‚ Emissions")
plt.show()

# Feature Importance
plt.barh(X.columns, rf.feature_importances_)
plt.title("Feature Importance - Random Forest")
plt.show()